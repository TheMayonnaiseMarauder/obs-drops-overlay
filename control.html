<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        html,body {
            background-color:#000000;
            height:100%;
            width:100%;
            padding:0;
            margin:0;
            color: #ffffff;
        }
        #videoProgress {
            width: 95%;
        }
        #setEm, #contentEm{
            background-color: black;
            border: red 1px solid;
            width: 50%;
            position: fixed;
            overflow: auto;
        }
        #setEm {
            height: 100%;
            top: 0;
            left: 0;
        }
        #contentEm {
            top: 0;
            right: 0;
            height: 100%
        }
        button {
            height: 25px;
            background-color: black;
            border: red 1px solid;
            color: white;
        }
        #status {
            float: right;
            width: 33%;
            right: 0;
            top: 0;
            border: red solid 1px;
        }
    </style>
    <title>control</title>
</head>
<body>
    <div id="setEm">
        <div id="status">
            <span id="connectionStatus"></span>
            <br>
            <span id="overlayStatus"></span>
        </div>
        <label for="speak">Speak:</label>
        <input value="Test" type="text" id="speak">
        <button onclick='sendSpeech(document.getElementById("speak").value)'>Speak</button>
        <br>
        <label for="vid">videoFile/Url:</label>
        <input value="" type="text" id="vid">
        <button onclick="sendVideo(document.getElementById('vid').value)">send vid</button>
        <button onclick="videoPR()">vid pause/resume</button>
        <button onclick="stopVideo()">stop vid</button>
        <br>
        <label for="videoVolume">Video Volume</label><input type="range" value=1.0 step=0.1 max=1 min=0 id="videoVolume" onchange="setVolume(document.getElementById('videoVolume').value, 'videoVolume')">
        <label for="videoProgress">videoProgress:<span id="videoProgressIntEm"></span></label><input type="range" min=0  step=0.01 max=10 id="videoProgress" onchange="setVideoProgress(document.getElementById('videoProgress').value)">
        <br>
        <button onclick="stopAudio('audio')">Stop audio</button>
        <button onclick="stopAudio('music')">Stop Music</button>
        <br>
        <label for="playbackRate">playbackRate</label><input type="range" value=1.0 step=0.1 max=1.0 min=0.4 id="playbackRate" onchange="setVolume(document.getElementById('playbackRate').value, 'playbackRate')">
        <br>
        <label for="audioVolume">Audio Volume</label><input type="range" value=1.0 step=0.01 max=1 min=0 id="audioVolume" onchange="setVolume(document.getElementById('audioVolume').value, 'audioVolume')">
        <br>
        <label for="musicVolume">Music Volume</label><input type="range" value=0.6 step=0.01 max=1 min=0 id="musicVolume" onchange="setVolume(document.getElementById('musicVolume').value, 'musicVolume')">
    </div>
    <div id="contentEm">
        <div id="dropsAudio">
            <p>Audio</p>
        </div>
        <div id="dropsVideo">
            <p>Video</p>
        </div>
        <div id="music">
            <p>Music</p>
        </div>
    </div>
    <script>
        // TODO : reload content button
        let serverIP = "{{ .IP }}";
        let port = "{{ .Port }}";
        let listUrl = `http://${serverIP}:${port}/list?type=`;
        let wsAddress = `ws://${serverIP}:${port}/controlWS`;
        let videoProgress = document.getElementById("videoProgress");
        let videoDropEm = document.getElementById("dropsVideo");
        let audioDropEm = document.getElementById("dropsAudio");
        let videoProgressIntEm = document.getElementById("videoProgressIntEm");
        let videoProgressDuration;
        let videoProgressCurrent;
        let musicEm = document.getElementById("music");
        let processMessage = (msg) => {
            let pj;
            try {
                pj = JSON.parse(msg.data);
            }
            catch (e) {
                console.log(e);
                return;
            }
            let action = pj["action"];
            let key = pj["key"];
            let value = pj["value"];
            switch (action) {
                case  "status":
                    switch (key) {
                        case "connection":
                            switch (value) {
                                case "connected":
                                    // 🤣🤣🤣🤣🤣
                                    overlayStatus = true;
                                    setStatus();
                                    break;
                            }
                            break;
                    }
                    break;
                case "video":
                    switch (key) {
                        case "progress":
                            videoProgress.value = value;
                            videoProgressCurrent = value;
                            break;
                        case "duration":
                            videoProgress.max = value;
                            videoProgressDuration = value;
                            break;
                    }
                    videoProgressIntEm.innerText = `${videoProgressCurrent}/${videoProgressDuration}`
                    break;
            }
        };
        let connectionStatus = false;
        let overlayStatus = false;
        let connectionStatusEm = document.getElementById("connectionStatus");
        let overlayStatusEm = document.getElementById("overlayStatus");
        console.log(`connecting to ${wsAddress}`)
        let ws;
        let connect = () => {
            ws = new WebSocket(wsAddress);
            ws.onopen = function() {
                connectionStatus = true;
                setStatus();
                console.log(`connected to ${wsAddress}`)
            }
            ws.onmessage = function(event) {processMessage(event)}
            ws.onclose = function(e) {
                connectionStatus = false;
                setStatus();
                console.log('Socket is closed. Reconnect will be attempted in 5 second(s).');
                ws = null;
                setTimeout(() => {
                    connect();
                }, 5000);
            }
            ws.onerror = function(err) {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                ws.close();
            }
        };
        let sendControlMessage = (action, key, value) => {
            ws.send(JSON.stringify({action: action, key: key, value: value}));
        };
        let sendSpeech = (text) => {
            sendControlMessage("speak", "", text);
        };
        let stopVideo = () => {
            sendControlMessage("video", "stop", "");
        };
        let videoPR = () => {
            sendControlMessage("video", "pr", "");
        };
        let sendVideo = (url) => {
            sendControlMessage("video", "play", url)
        };
        let setVideoProgress = (location) => {
            sendControlMessage("video", "seek", location);
        };
        let setStatus = () => {
            try {
                // TODO : receive heartbeat from overlay, this is just a working placeholder
                if (connectionStatus) {
                    connectionStatusEm.innerText = "Connected to server";
                    connectionStatusEm.style.color = "green";
                } else {
                    connectionStatusEm.innerText = "Disconnected";
                    connectionStatusEm.style.color = "red";
                }
                if (overlayStatus) {
                    overlayStatusEm.innerText = "Overlay Connected";
                    overlayStatusEm.style.color = "green";
                } else {
                    overlayStatusEm.innerText = "Overlay Disconnected";
                    overlayStatusEm.style.color = "red";
                }
            }
            catch (e) {
                console.log("failed to get element")
            }
        }
        let sendAudio = (url) => {
            sendControlMessage("audio", "play", url)
        };
        let stopAudio = (type) => {
            sendControlMessage("audio", "stop", type)
        }
        let setVolume = (level, type) => {
            sendControlMessage("volume", type, level);
        };
        let addDrop = (filename) => {
            let filenameExt = filename.substring(filename.length - 4);
            switch (filenameExt) {
                case ".mp3":
                    audioDropEm.insertAdjacentHTML("beforeend", `<button onclick="sendAudio('drops/${filename}')">${filename}</button>`);
                    break;
                case ".mp4":
                    videoDropEm.insertAdjacentHTML("beforeend", `<button onclick="sendVideo('drops/${filename}')">${filename}</button>`);
                    break;
                case ".mkv":
                    videoDropEm.insertAdjacentHTML("beforeend", `<button onclick="sendVideo('drops/${filename}')">${filename}</button>`);
                    break;
            }
        };
        let loadDrops = () => {
            fetch(`${listUrl}drops`).then(response => {
                return response.json();
            }).then(data => {
                data["files"].forEach((value) => {
                    addDrop(value);
                })
            }).catch(err => {
                console.log("error", err);
            });
        };
        let addMusic = (filename) => {
            let filenameExt = filename.substring(filename.length - 4);
            if (filenameExt === ".mp3") {
                musicEm.insertAdjacentHTML("beforeend", `<button onclick="sendAudio('music/${filename}')">${filename}</button>`);
            }
        };
        let loadMusic = () => {
            fetch(`${listUrl}music`).then(response => {
                return response.json();
            }).then(data => {
                data["files"].forEach((value) => {
                    addMusic(value);
                })
            }).catch(err => {
                console.log("error", err);
            });
        };
        window.addEventListener('load', function() {
            console.log('All assets are loaded')
            connect();
            loadDrops();
            loadMusic();
        })
    </script>
</body>
</html>
